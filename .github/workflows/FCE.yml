name: 🔧 Firmware Extraction

on:
  workflow_dispatch:
    inputs:
      url:
        required: true
        type: string
      track:
        required: false
        type: string
      image_type:
        required: true
        type: string
        default: 'boot'

permissions:
  contents: write
  actions: read

jobs:
  extract:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 🔍 Girişleri kontrol et
        run: |
          echo "📥 URL: ${{ inputs.url }}"
          echo "🔧 Tip: ${{ inputs.image_type }}"
          echo "🆔 Track ID: ${{ inputs.track || 'Yok' }}"

      - name: 🛠️ Gerekenleri kur
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            android-sdk-libsparse-utils \
            p7zip-full \
            aria2 \
            brotli

      - name: ⬇️ Firmware indir
        run: |
          aria2c -x 8 -s 8 -o firmware.zip "${{ inputs.url }}"
          [ -f firmware.zip ] || (echo "❌ İndirme başarısız" && exit 1)

      - name: 📦 Dosyaları çıkar
        run: |
          7z x firmware.zip -oextracted -y
          rm -f firmware.zip

      - name: 🔎 Görüntüleri bul
        id: find_files
        run: |
          cd extracted
          case "${{ inputs.image_type }}" in
            boot) pattern="boot.img" ;;
            recovery) pattern="recovery.img" ;;
            modem) pattern="NON-HLOS.bin md1img.img modem.bin modem.img" ;;
          esac

          # Dosyayı ara
          file=$(find . -type f \( -name "*.img" -o -name "*.bin" \) | grep -iE "$pattern" | head -1)

          # Payload.bin fallback
          [ -z "$file" ] && [ -f payload.bin ] && {
            echo "⚙️ Payload.bin'den çıkarılıyor..."
            git clone https://github.com/vm03/payload_dumper.git
            python3 -m pip install protobuf pyelftools
            python3 payload_dumper/payload_dumper.py payload.bin
            file=$(find . -type f \( -name "*.img" -o -name "*.bin" \) | grep -iE "$pattern" | head -1)
          }

          [ -z "$file" ] && echo "❌ Dosya bulunamadı" && exit 1
          echo "file_path=$file" >> $GITHUB_OUTPUT

      - name: 📁
