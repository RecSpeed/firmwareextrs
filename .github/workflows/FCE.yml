name: Firmware Extraction

on:
  workflow_dispatch:
    inputs:
      url:
        required: true
        type: string
      track:
        required: false
        type: string
      image_type:
        required: true
        default: 'boot'
        type: choice
        options: ['boot', 'recovery', 'modem']

concurrency:
  group: extract-${{ inputs.image_type }}-${{ hash(inputs.url) }}
  cancel-in-progress: true

jobs:
  extract:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            android-sdk-libsparse-utils \
            p7zip-full \
            aria2 \
            brotli \
            jq

      - name: Download
        run: |
          aria2c -x 8 -s 8 -o firmware.zip "${{ inputs.url }}" || exit 1
          [ -f firmware.zip ] || (echo "Download failed" && exit 1)

      - name: Extract
        run: |
          7z x firmware.zip -oextracted -y
          rm -f firmware.zip

      - name: Find Images
        id: find
        run: |
          cd extracted
          case "${{ inputs.image_type }}" in
            boot) patterns="boot.img" ;;
            recovery) patterns="recovery.img" ;;
            modem) patterns="NON-HLOS.bin md1img.img modem.bin modem.img" ;;
          esac

          for pattern in $patterns; do
            file=$(find . -name "$pattern" | head -1)
            [ -f "$file" ] && break
          done

          [ -z "$file" ] && [ -f payload.bin ] && {
            python3 -m pip install protobuf pyelftools
            git clone https://github.com/vm03/payload_dumper.git
            python3 payload_dumper/payload_dumper.py payload.bin
            file=$(find . -name "$pattern" | head -1)
          }

          [ -z "$file" ] && exit 1
          echo "file=$file" >> $GITHUB_OUTPUT

      - name: Package
        run: |
          cd extracted
          output="${{ inputs.image_type }}_$(basename "${{ inputs.url }}" .zip).zip"
          7z a "../$output" "${{ steps.find.outputs.file }}"

      - name: Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: auto
          files: ${{ inputs.image_type }}_*.zip
