name: Enhanced Firmware Extraction

on:
  workflow_dispatch:
    inputs:
      url:
        required: true
        description: 'Firmware ZIP URL'
      firmware_name:
        required: true
        description: 'Firmware Base Name (without .zip)'
      track:
        required: false
        description: 'Tracking ID'
      image_type:
        required: true
        default: 'boot'
        description: 'boot/recovery/modem/system_ext'

concurrency:
  group: extract-${{ inputs.image_type }}-${{ inputs.firmware_name }}
  cancel-in-progress: true

jobs:
  extract:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check inputs
        run: |
          echo "Processing ${{ inputs.image_type }} from ${{ inputs.url }}"
          echo "Firmware Name: ${{ inputs.firmware_name }}"
          echo "Track ID: ${{ inputs.track || 'None' }}"

      # ... [İşlem adımlarını buraya tekrar yazmadım, sadece KV update kısmı aşağıda]

      - name: Update KV on Success
        if: success()
        run: |
          key="${{ inputs.image_type }}:${{ inputs.firmware_name }}"
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          file="${{ steps.process.outputs.file_name }}"
          data="{\"state\": \"complete\", \"timestamp\": \"$timestamp\", \"error\": null, \"file\": \"$file\"}"
          echo "Updating KV (success): $data"
          response=$(curl -sS -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_NAMESPACE_ID }}/values/$key" \
            -H "X-Auth-Email: ${{ secrets.CF_X_AUTH_EMAIL }}" \
            -H "X-Auth-Key: ${{ secrets.CF_X_AUTH_KEY }}" \
            -H "Content-Type: application/json" \
            --data "$data")

          if [[ "$(echo "$response" | jq -r .success)" != "true" ]]; then
            echo "::error::KV güncelleme başarısız (success): $response"
            exit 1
          fi

      - name: Update KV on Failure
        if: failure()
        run: |
          key="${{ inputs.image_type }}:${{ inputs.firmware_name }}"
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          error_msg=$(grep "::error::" "$GITHUB_STEP_SUMMARY" | sed -n 's/.*::error:://p' | tail -1 || echo "Unknown failure")
          data="{\"state\": \"failed\", \"timestamp\": \"$timestamp\", \"error\": \"$error_msg\", \"tracking_url\": \"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"}"
          echo "Updating KV (failure): $data"
          response=$(curl -sS -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_NAMESPACE_ID }}/values/$key" \
            -H "X-Auth-Email: ${{ secrets.CF_X_AUTH_EMAIL }}" \
            -H "X-Auth-Key: ${{ secrets.CF_X_AUTH_KEY }}" \
            -H "Content-Type: application/json" \
            --data "$data")

          if [[ "$(echo "$response" | jq -r .success)" != "true" ]]; then
            echo "::error::KV güncelleme başarısız (failure): $response"
            exit 1
          fi
