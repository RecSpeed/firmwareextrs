name: Firmware Extraction

on:
  workflow_dispatch:
    inputs:
      url:
        required: true
        description: 'Firmware ZIP URL'
      track:
        required: false
        description: 'Tracking ID'
      image_type:
        required: true
        default: 'boot'
        description: 'boot/recovery/modem'

env:
  SEARCH_PATHS: ". firmware-update firmware images radio"
  MAX_RETRIES: 3
  RETRY_DELAY: 10

jobs:
  extract:
    name: Extract ${{ inputs.image_type }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Validate Inputs
        run: |
          echo "Starting processing for Track ID: ${{ inputs.track }}"
          if [[ ! "${{ inputs.url }}" =~ \.zip($|\?) ]]; then
            echo "::error::Invalid URL pattern"
            exit 1
          fi
          echo "Processing ${{ inputs.image_type }} image from ${{ inputs.url }}"

      - uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            android-sdk-libsparse-utils \
            p7zip-full \
            aria2 \
            brotli \
            python3-pip \
            jq \
            curl

          sudo ln -sf /usr/lib/android-sdk/libsparse-utils/simg2img /usr/local/bin/

          if [ ! -d "tools" ]; then
            git clone https://github.com/vm03/payload_dumper.git tools
          fi

          pip install -q protobuf pyelftools
          echo "Environment setup completed"

      - name: Download Firmware
        run: |
          for i in $(seq 1 $MAX_RETRIES); do
            if aria2c -x 8 -s 8 --out=firmware.zip "${{ inputs.url }}"; then
              echo "Download completed successfully"
              break
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "::error::Download failed after $MAX_RETRIES attempts"
              exit 1
            fi
            
            echo "Attempt $i failed, retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          done

      - name: Extract Files
        run: |
          mkdir -p extracted
          7z x firmware.zip -oextracted -y
          rm -f firmware.zip
          echo "Extracted files structure:"
          find extracted -type f | head -n 20

      - name: Process Images
        id: process
        run: |
          cd extracted
          rom_name=$(basename "${{ inputs.url }}" .zip)
          output_file="${{ inputs.image_type }}_${rom_name}.zip"
          mkdir -p ../release
          
          declare -A file_patterns=(
            ["boot"]="boot.img"
            ["recovery"]="recovery.img"
            ["modem"]="NON-HLOS.bin md1img.img modem.bin modem.img"
          )

          found_file=""
          for path in $SEARCH_PATHS; do
            [ ! -d "$path" ] && continue
            for pattern in ${file_patterns[${{ inputs.image_type }}]}; do
              file_path="$path/$pattern"
              if [ -f "$file_path" ]; then
                echo "Found $file_path"
                7z a "../release/$output_file" "$file_path"
                found_file="$file_path"
                break 2
              fi
            done
          done

          if [ -z "$found_file" ] && [ -f "payload.bin" ]; then
            echo "Extracting from payload.bin..."
            python3 ../tools/payload_dumper.py --out . --images "${{ inputs.image_type }}"* payload.bin
            
            for pattern in ${file_patterns[${{ inputs.image_type }}]}; do
              if [ -f "$pattern" ]; then
                echo "Found extracted $pattern"
                7z a "../release/$output_file" "$pattern"
                found_file="$pattern"
                break
              fi
            done
          fi

          if [ -z "$found_file" ]; then
            echo "::error::No ${{ inputs.image_type }} files found"
            exit 1
          fi

          echo "output_file=$output_file" >> $GITHUB_OUTPUT

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: auto
          files: release/${{ steps.process.outputs.output_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -rf extracted release

      - name: Update KV Store (Optional)
        if: success()
        run: |
          echo "KV update skipped in simplified version"
